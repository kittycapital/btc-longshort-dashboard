<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¡±ìˆ ë¹„ìœ¨ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #08080d;
  --bg-card: #101018;
  --bg-card-hover: #161622;
  --bg-elevated: #1a1a28;
  --border: #1c1c2e;
  --border-glow: #2a2a45;
  --text-primary: #e8e8f0;
  --text-secondary: #8888a8;
  --text-muted: #555570;
  --green: #00d68f;
  --green-dim: #00d68f33;
  --red: #ff3d71;
  --red-dim: #ff3d7133;
  --blue: #3366ff;
  --orange: #f0a030;
  --purple: #9966ff;
  --cyan: #00cfff;
  --yellow: #ffd866;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: 'Noto Sans KR', sans-serif;
  line-height: 1.6;
}

.mono { font-family: 'JetBrains Mono', monospace; }

/* â”€â”€â”€ Header â”€â”€â”€ */
.header {
  padding: 24px 28px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, #0c0c14 0%, var(--bg-primary) 100%);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}

.header h1 {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header h1 .icon {
  font-size: 22px;
}

.header-meta {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 11px;
  color: var(--text-muted);
}

.header-meta .dot {
  width: 6px; height: 6px;
  background: var(--green);
  border-radius: 50%;
  display: inline-block;
  margin-right: 4px;
  animation: pulse 2s infinite;
}

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.period-selector {
  display: flex;
  gap: 4px;
  margin-top: 12px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.period-selector::-webkit-scrollbar { display: none; }

.period-btn {
  padding: 6px 16px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: transparent;
  color: var(--text-secondary);
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
}
.period-btn:hover { border-color: var(--border-glow); color: var(--text-primary); }
.period-btn.active { background: var(--blue); color: #fff; border-color: var(--blue); font-weight: 600; }

/* â”€â”€â”€ Dashboard â”€â”€â”€ */
.dashboard {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* â”€â”€â”€ Signal Banner â”€â”€â”€ */
.signal-banner {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.signal-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 18px;
}

.signal-box h3 {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.signal-box.long-box h3 { color: var(--red); }
.signal-box.short-box h3 { color: var(--green); }

.signal-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.signal-item:last-child { border-bottom: none; }

.signal-item .coin-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.signal-item .coin-info img {
  width: 20px;
  height: 20px;
  border-radius: 50%;
}

.signal-item .coin-symbol {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  font-size: 13px;
}

.signal-item .ratio-bar {
  display: flex;
  align-items: center;
  gap: 6px;
}

.ratio-bar .bar-wrap {
  width: 80px;
  height: 6px;
  background: var(--bg-primary);
  border-radius: 3px;
  overflow: hidden;
}

.ratio-bar .bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s;
}

.ratio-bar .pct {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  font-weight: 600;
  min-width: 42px;
  text-align: right;
}

/* â”€â”€â”€ Coin Table â”€â”€â”€ */
.section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 18px;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-subtitle {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 14px;
}

.table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.table-wrap::-webkit-scrollbar { height: 4px; }
.table-wrap::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 2px; }

.coin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  min-width: 700px;
}

.coin-table th {
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
  text-align: right;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
}
.coin-table th:first-child, .coin-table th:nth-child(2) { text-align: left; }
.coin-table th:hover { color: var(--text-secondary); }
.coin-table th.sorted { color: var(--blue); }

.coin-table td {
  padding: 10px 10px;
  border-bottom: 1px solid var(--border);
  text-align: right;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  white-space: nowrap;
}

.coin-table td:first-child {
  text-align: center;
  color: var(--text-muted);
  font-size: 11px;
  width: 30px;
}

.coin-table td:nth-child(2) {
  text-align: left;
  font-family: 'Noto Sans KR', sans-serif;
}

.coin-table tr:hover td { background: var(--bg-elevated); }
.coin-table tr { cursor: pointer; }

.coin-cell {
  display: flex;
  align-items: center;
  gap: 8px;
}

.coin-cell img { width: 22px; height: 22px; border-radius: 50%; }
.coin-cell .symbol { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 13px; }
.coin-cell .name { color: var(--text-muted); font-size: 11px; margin-left: 4px; }

.pos { color: var(--green); }
.neg { color: var(--red); }
.neutral-color { color: var(--text-secondary); }

.long-pct { color: var(--red); font-weight: 500; }
.short-pct { color: var(--green); font-weight: 500; }

.signal-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  font-family: 'Noto Sans KR', sans-serif;
}
.signal-badge.extreme_long { background: var(--red-dim); color: var(--red); }
.signal-badge.long { background: #ff3d7118; color: #ff6b8a; }
.signal-badge.extreme_short { background: var(--green-dim); color: var(--green); }
.signal-badge.short { background: #00d68f18; color: #33e0a8; }
.signal-badge.neutral { background: transparent; color: var(--text-muted); }

/* â”€â”€â”€ Mini LS Bar â”€â”€â”€ */
.ls-bar {
  display: flex;
  align-items: center;
  gap: 4px;
}
.ls-bar .bar-track {
  width: 60px;
  height: 5px;
  background: var(--green-dim);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}
.ls-bar .bar-long {
  height: 100%;
  background: var(--red);
  border-radius: 3px 0 0 3px;
  transition: width 0.4s;
}

/* â”€â”€â”€ Detail Chart â”€â”€â”€ */
.chart-container {
  position: relative;
  width: 100%;
  height: 320px;
}

.detail-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 14px;
}

.detail-coin {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
  font-weight: 700;
}

.detail-coin img { width: 28px; height: 28px; border-radius: 50%; }

.detail-stats {
  display: flex;
  gap: 20px;
  font-size: 12px;
}

.detail-stats .stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.detail-stats .stat-label {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
}

.detail-stats .stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  font-size: 14px;
}

/* â”€â”€â”€ Footer â”€â”€â”€ */
.footer {
  text-align: center;
  padding: 20px;
  font-size: 10px;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
}

/* â”€â”€â”€ Loading â”€â”€â”€ */
.loading {
  display: flex; align-items: center; justify-content: center;
  height: 200px; color: var(--text-muted); font-size: 14px;
}
.spinner {
  width: 18px; height: 18px;
  border: 2px solid var(--border); border-top-color: var(--blue);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ Responsive â”€â”€â”€ */
@media (max-width: 900px) {
  .header { padding: 16px 14px 12px; }
  .dashboard { padding: 12px; gap: 12px; }
  .section { padding: 14px; }
  .chart-container { height: 260px; }
  .signal-banner { grid-template-columns: 1fr; }
  .detail-stats { gap: 12px; }
}

@media (max-width: 500px) {
  .header h1 { font-size: 17px; }
  .header-meta { font-size: 10px; }
  .coin-table { font-size: 11px; }
  .period-btn { padding: 8px 14px; font-size: 13px; }
  .chart-container { height: 230px; }
  .detail-coin { font-size: 16px; }
  .detail-stats .stat-value { font-size: 12px; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1><span class="icon">ğŸ“Š</span> ë¡±ìˆ ë¹„ìœ¨ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="header-meta">
      <span><span class="dot"></span> ìë™ ì—…ë°ì´íŠ¸</span>
      <span id="lastUpdated">-</span>
    </div>
  </div>
  <div class="period-selector">
    <button class="period-btn active" data-period="1">1ì¼</button>
    <button class="period-btn" data-period="7">1ì£¼</button>
    <button class="period-btn" data-period="30">1ë‹¬</button>
  </div>
</div>

<div class="dashboard">
  <!-- Signal Banner: Top 5 Long / Top 5 Short -->
  <div class="signal-banner" id="signalBanner">
    <div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>

  <!-- Coin Table -->
  <div class="section">
    <div class="section-title">ğŸ“‹ ì „ì²´ ì½”ì¸ ë¡±ìˆ ë¹„ìœ¨</div>
    <div class="section-subtitle">Binance Â· Bybit íƒ‘ íŠ¸ë ˆì´ë” ë¡±/ìˆ ë¹„ìœ¨ Â· ì½”ì¸ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì°¨íŠ¸</div>
    <div class="table-wrap" id="coinTableWrap">
      <div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <!-- Detail Chart -->
  <div class="section" id="detailSection" style="display:none;">
    <div class="detail-header" id="detailHeader"></div>
    <div class="chart-container">
      <canvas id="detailChart"></canvas>
    </div>
  </div>
</div>

<div class="footer">
  ë°ì´í„° ì¶œì²˜: Binance Â· Bybit Â· CoinGecko Â· ìë™ ì—…ë°ì´íŠ¸ Â· íˆ¬ì ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤
</div>

<script>
// â”€â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isMobile = window.innerWidth <= 600;
let allData = null;
let selectedCoin = null;
let detailChart = null;
let currentSort = { col: 'market_cap_rank', dir: 'asc' };

if (typeof Chart !== 'undefined') {
  Chart.defaults.color = '#8888a8';
  Chart.defaults.borderColor = '#1c1c2e';
  Chart.defaults.font.family = "'JetBrains Mono', 'Noto Sans KR', monospace";
  Chart.defaults.font.size = isMobile ? 10 : 11;
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (v, d=1) => v != null ? (v > 0 ? '+' : '') + v.toFixed(d) : '-';
const pct = (v) => v != null ? (v * 100).toFixed(1) + '%' : '-';
const fmtPrice = (p) => {
  if (p >= 1000) return '$' + p.toLocaleString('en-US', { maximumFractionDigits: 0 });
  if (p >= 1) return '$' + p.toFixed(2);
  if (p >= 0.01) return '$' + p.toFixed(4);
  return '$' + p.toFixed(6);
};

// â”€â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    const resp = await fetch('data/coins.json');
    allData = await resp.json();
    console.log(`[LS] Loaded: ${allData.coins.length} coins`);
    renderAll();
  } catch (e) {
    console.error('[LS] Failed to load data:', e);
    document.getElementById('signalBanner').innerHTML =
      '<div class="loading" style="color:#ff3d71">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ â€” data/coins.jsonì„ í™•ì¸í•˜ì„¸ìš”</div>';
  }
}

// â”€â”€â”€ Render All â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  if (!allData) return;
  document.getElementById('lastUpdated').textContent =
    'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date(allData.updated_at).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

  renderSignalBanner(allData.coins);
  renderCoinTable(allData.coins);
}

// â”€â”€â”€ Signal Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSignalBanner(coins) {
  // Sort by long percentage (Binance global)
  const withRatio = coins.filter(c => c.binance?.global_account?.long);
  const sorted = [...withRatio].sort((a, b) =>
    (b.binance.global_account.long) - (a.binance.global_account.long)
  );

  const topLong = sorted.slice(0, 5);
  const topShort = sorted.slice(-5).reverse();

  let html = `
    <div class="signal-box long-box">
      <h3>ğŸ”´ ë¡± ê³¼ë°€ TOP 5</h3>
      ${topLong.map(c => renderSignalItem(c, 'long')).join('')}
    </div>
    <div class="signal-box short-box">
      <h3>ğŸŸ¢ ìˆ ê³¼ë°€ TOP 5</h3>
      ${topShort.map(c => renderSignalItem(c, 'short')).join('')}
    </div>
  `;
  document.getElementById('signalBanner').innerHTML = html;
}

function renderSignalItem(coin, type) {
  const longPct = coin.binance?.global_account?.long || 0.5;
  const displayPct = type === 'long' ? longPct : (1 - longPct);
  const barColor = type === 'long' ? 'var(--red)' : 'var(--green)';
  const pctColor = type === 'long' ? 'var(--red)' : 'var(--green)';

  return `
    <div class="signal-item" onclick="selectCoin('${coin.symbol}')">
      <div class="coin-info">
        <img src="${coin.image}" alt="${coin.symbol}" onerror="this.style.display='none'">
        <span class="coin-symbol">${coin.symbol}</span>
      </div>
      <div class="ratio-bar">
        <div class="bar-wrap">
          <div class="bar-fill" style="width: ${displayPct * 100}%; background: ${barColor}"></div>
        </div>
        <span class="pct" style="color: ${pctColor}">${(displayPct * 100).toFixed(1)}%</span>
      </div>
    </div>
  `;
}

// â”€â”€â”€ Coin Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCoinTable(coins) {
  const sorted = sortCoins([...coins], currentSort.col, currentSort.dir);

  const sortIcon = (col) => currentSort.col === col ? (currentSort.dir === 'asc' ? ' â†‘' : ' â†“') : '';
  const sortCls = (col) => currentSort.col === col ? 'sorted' : '';

  let html = `<table class="coin-table">
    <thead><tr>
      <th onclick="doSort('market_cap_rank')" class="${sortCls('market_cap_rank')}">#${sortIcon('market_cap_rank')}</th>
      <th onclick="doSort('symbol')" class="${sortCls('symbol')}">ì½”ì¸${sortIcon('symbol')}</th>
      <th onclick="doSort('price')" class="${sortCls('price')}">ê°€ê²©${sortIcon('price')}</th>
      <th onclick="doSort('price_change_24h')" class="${sortCls('price_change_24h')}">24h${sortIcon('price_change_24h')}</th>
      <th onclick="doSort('binance_long')" class="${sortCls('binance_long')}">Binance ë¡±${sortIcon('binance_long')}</th>
      <th>ë¡±/ìˆ</th>
      <th onclick="doSort('bybit_long')" class="${sortCls('bybit_long')}">Bybit ë¡±${sortIcon('bybit_long')}</th>
      <th onclick="doSort('signal_strength')" class="${sortCls('signal_strength')}">ì‹œê·¸ë„${sortIcon('signal_strength')}</th>
    </tr></thead><tbody>`;

  sorted.forEach((c, i) => {
    const binanceLong = c.binance?.global_account?.long;
    const bybitLong = c.bybit?.long;
    const priceCls = (c.price_change_24h || 0) >= 0 ? 'pos' : 'neg';
    const signal = c.signal || 'neutral';
    const signalText = {
      extreme_long: 'ğŸ”´ ê·¹ë‹¨ ë¡±',
      long: 'ë¡± ê³¼ë°€',
      extreme_short: 'ğŸŸ¢ ê·¹ë‹¨ ìˆ',
      short: 'ìˆ ê³¼ë°€',
      neutral: '-'
    }[signal];

    html += `<tr onclick="selectCoin('${c.symbol}')">
      <td>${c.market_cap_rank || i + 1}</td>
      <td>
        <div class="coin-cell">
          <img src="${c.image}" alt="${c.symbol}" onerror="this.style.display='none'">
          <span class="symbol">${c.symbol}</span>
          <span class="name">${c.name || ''}</span>
        </div>
      </td>
      <td>${fmtPrice(c.price || 0)}</td>
      <td class="${priceCls}">${fmt(c.price_change_24h, 1)}%</td>
      <td>
        ${binanceLong != null ? `<span class="long-pct">${(binanceLong * 100).toFixed(1)}%</span>` : '-'}
      </td>
      <td>
        ${binanceLong != null ? `
          <div class="ls-bar">
            <div class="bar-track">
              <div class="bar-long" style="width: ${binanceLong * 100}%"></div>
            </div>
          </div>
        ` : '-'}
      </td>
      <td>
        ${bybitLong != null ? `<span class="long-pct">${(bybitLong * 100).toFixed(1)}%</span>` : '-'}
      </td>
      <td><span class="signal-badge ${signal}">${signalText}</span></td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('coinTableWrap').innerHTML = html;
}

// â”€â”€â”€ Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sortCoins(coins, col, dir) {
  return coins.sort((a, b) => {
    let va, vb;
    switch (col) {
      case 'market_cap_rank': va = a.market_cap_rank || 999; vb = b.market_cap_rank || 999; break;
      case 'symbol': va = a.symbol; vb = b.symbol; return dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      case 'price': va = a.price || 0; vb = b.price || 0; break;
      case 'price_change_24h': va = a.price_change_24h || 0; vb = b.price_change_24h || 0; break;
      case 'binance_long': va = a.binance?.global_account?.long || 0.5; vb = b.binance?.global_account?.long || 0.5; break;
      case 'bybit_long': va = a.bybit?.long || 0.5; vb = b.bybit?.long || 0.5; break;
      case 'signal_strength': va = a.signal_strength || 0; vb = b.signal_strength || 0; break;
      default: va = 0; vb = 0;
    }
    return dir === 'asc' ? va - vb : vb - va;
  });
}

function doSort(col) {
  if (currentSort.col === col) {
    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.col = col;
    currentSort.dir = col === 'market_cap_rank' ? 'asc' : 'desc';
  }
  renderCoinTable(allData.coins);
}

// â”€â”€â”€ Detail Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectCoin(symbol) {
  selectedCoin = symbol;
  const coin = allData.coins.find(c => c.symbol === symbol);
  if (!coin) return;

  const section = document.getElementById('detailSection');
  section.style.display = 'block';

  // Header
  const binanceLong = coin.binance?.global_account?.long;
  const bybitLong = coin.bybit?.long;

  document.getElementById('detailHeader').innerHTML = `
    <div class="detail-coin">
      <img src="${coin.image}" alt="${symbol}" onerror="this.style.display='none'">
      ${symbol} ë¡±ìˆ ì¶”ì´
    </div>
    <div class="detail-stats">
      <div class="stat">
        <span class="stat-label">Binance ë¡±</span>
        <span class="stat-value long-pct">${binanceLong != null ? (binanceLong * 100).toFixed(1) + '%' : '-'}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Bybit ë¡±</span>
        <span class="stat-value long-pct">${bybitLong != null ? (bybitLong * 100).toFixed(1) + '%' : '-'}</span>
      </div>
      <div class="stat">
        <span class="stat-label">ê°€ê²©</span>
        <span class="stat-value">${fmtPrice(coin.price || 0)}</span>
      </div>
    </div>
  `;

  // Chart data
  const history = allData.histories?.[symbol] || [];
  if (history.length === 0) {
    section.querySelector('.chart-container').innerHTML =
      '<div class="loading">ì´ ì½”ì¸ì˜ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  } else {
    section.querySelector('.chart-container').innerHTML = '<canvas id="detailChart"></canvas>';
  }

  // Filter by period
  const periodDays = parseInt(document.querySelector('.period-btn.active').dataset.period);
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - periodDays);

  const filtered = history.filter(h => new Date(h.timestamp) >= cutoff);
  const labels = filtered.map(h => {
    const d = new Date(h.timestamp);
    return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00`;
  });

  // Also get price data from daily history
  const dailyHist = allData.daily_history || {};
  const pricePoints = [];
  const priceLabels = [];
  Object.keys(dailyHist).sort().forEach(date => {
    const dayData = dailyHist[date];
    if (dayData[symbol]) {
      pricePoints.push(dayData[symbol].price);
      priceLabels.push(date);
    }
  });

  const ctx = document.getElementById('detailChart');
  if (detailChart) detailChart.destroy();

  detailChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'ë¡± ë¹„ìœ¨',
          data: filtered.map(h => h.long * 100),
          borderColor: '#ff3d71',
          backgroundColor: '#ff3d7120',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 4,
          borderWidth: 2,
          yAxisID: 'y',
        },
        {
          label: 'ìˆ ë¹„ìœ¨',
          data: filtered.map(h => h.short * 100),
          borderColor: '#00d68f',
          backgroundColor: '#00d68f20',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 4,
          borderWidth: 2,
          yAxisID: 'y',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: {
          labels: { boxWidth: isMobile ? 8 : 12, padding: isMobile ? 8 : 14 }
        },
        tooltip: {
          backgroundColor: '#1a1a28',
          borderColor: '#2a2a45',
          borderWidth: 1,
          callbacks: {
            label: (item) => `${item.dataset.label}: ${item.raw.toFixed(1)}%`
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: isMobile ? 5 : 10 }
        },
        y: {
          grid: { color: '#1c1c2e44' },
          ticks: { callback: v => v + '%' },
          min: 20,
          max: 80,
        }
      }
    }
  });

  // Scroll to chart
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â”€â”€â”€ Period Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelector('.period-btn.active').classList.remove('active');
    btn.classList.add('active');
    if (selectedCoin) selectCoin(selectedCoin);
  });
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();

// â”€â”€â”€ imweb iframe auto-height â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function postHeight() {
  const h = document.documentElement.scrollHeight;
  window.parent.postMessage({ type: 'resize', height: h }, '*');
  window.parent.postMessage({ height: h }, '*');
  window.parent.postMessage(JSON.stringify({ event: 'setHeight', height: h }), '*');
}
const heightObserver = new ResizeObserver(() => postHeight());
heightObserver.observe(document.body);
window.addEventListener('load', () => setTimeout(postHeight, 500));
</script>
</body>
</html>
